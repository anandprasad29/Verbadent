# Fastlane configuration for Verbident
#
# VERSION FORMAT: major.minor.patch+build (e.g., 1.2.3+45)
#
# WHEN TO BUMP WHAT:
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ Componentâ”‚ When to bump                                              â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚ MAJOR   â”‚ Breaking changes, major redesign, incompatible API changes â”‚
# â”‚ MINOR   â”‚ New features, significant improvements (backwards compat)  â”‚
# â”‚ PATCH   â”‚ Bug fixes, small improvements, text changes                â”‚
# â”‚ BUILD   â”‚ Every TestFlight/Play Store upload (auto-incremented)      â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# DEPLOYMENT COMMANDS:
#   fastlane ios beta           - Build and upload to TestFlight
#   fastlane android beta       - Build and upload to Play Store Internal
#
# METADATA COMMANDS:
#   fastlane ios metadata       - Upload App Store metadata only
#   fastlane android metadata   - Upload Play Store metadata only
#   fastlane ios screenshots    - Capture iOS screenshots
#   fastlane android screenshots - Capture Android screenshots
#
# VERSION COMMANDS:
#   fastlane version      - Show current version
#   fastlane bump         - Increment build number only
#   fastlane bump_patch   - Bump patch version (0.2.0 â†’ 0.2.1)
#   fastlane bump_minor   - Bump minor version (0.2.1 â†’ 0.3.0)
#   fastlane bump_major   - Bump major version (0.3.0 â†’ 1.0.0)

default_platform(:ios)

PROJECT_ROOT = File.expand_path("..", __dir__)

# =====================
# iOS API KEY HELPER
# =====================
def ios_api_key
  app_store_connect_api_key(
    key_id: "W663NX6L7M",
    issuer_id: "f3d4bbef-fcdf-4d27-8e8f-ae2b998abb50",
    key_filepath: "#{PROJECT_ROOT}/fastlane/AuthKey_W663NX6L7M.p8"
  )
end

# =====================
# ANDROID LANES
# =====================
platform :android do
  desc "Build and upload to Play Store Internal Testing"
  lane :beta do
    Dir.chdir(PROJECT_ROOT) do
      sh("flutter build appbundle --release")
    end
    
    upload_to_play_store(
      track: "internal",
      aab: "#{PROJECT_ROOT}/build/app/outputs/bundle/release/app-release.aab",
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true,
      release_status: "draft"
    )
    
    UI.success("âœ… Android build uploaded to Internal Testing!")
  end
  
  desc "Upload Play Store metadata only (no binary)"
  lane :metadata do
    upload_to_play_store(
      skip_upload_aab: true,
      skip_upload_apk: true,
      skip_upload_screenshots: false,
      skip_upload_images: false,
      skip_upload_metadata: false
    )
    
    UI.success("âœ… Android metadata uploaded to Play Store!")
  end
  
  desc "Capture Android screenshots"
  lane :screenshots do
    UI.message("ğŸ“± Android Screenshot Capture")
    UI.message("============================")
    
    # Build the app
    Dir.chdir(PROJECT_ROOT) do
      sh("flutter build apk --release")
    end
    
    # Run screengrab (requires emulator running)
    # screengrab
    
    UI.important("For manual screenshots:")
    UI.message("1. Start emulator: emulator -avd <name>")
    UI.message("2. Run: flutter run -d emulator-5554")
    UI.message("3. Navigate to each screen")
    UI.message("4. Capture: adb shell screencap -p /sdcard/screen.png && adb pull /sdcard/screen.png")
    UI.message("5. Save to: fastlane/metadata/android/en-US/images/phoneScreenshots/")
  end
  
  desc "Full release with metadata"
  lane :release do
    Dir.chdir(PROJECT_ROOT) do
      sh("flutter build appbundle --release")
    end
    
    upload_to_play_store(
      track: "internal",
      aab: "#{PROJECT_ROOT}/build/app/outputs/bundle/release/app-release.aab",
      skip_upload_metadata: false,
      skip_upload_images: false,
      skip_upload_screenshots: false,
      release_status: "draft"
    )
    
    UI.success("âœ… Android release with metadata uploaded!")
  end
end

# =====================
# iOS LANES
# =====================
platform :ios do
  desc "Build and upload to TestFlight"
  lane :beta do
    ENV["PATH"] = "/usr/bin:" + ENV["PATH"]
    
    api_key = ios_api_key
    
    get_certificates(
      api_key: api_key,
      platform: "ios"
    )
    
    get_provisioning_profile(
      api_key: api_key,
      app_identifier: "com.verbident",
      platform: "ios"
    )
    
    Dir.chdir(PROJECT_ROOT) do
      sh("flutter build ios --release --no-codesign")
    end
    
    build_app(
      workspace: "#{PROJECT_ROOT}/ios/Runner.xcworkspace",
      scheme: "Runner",
      export_method: "app-store",
      output_directory: "#{PROJECT_ROOT}/build/ios/ipa",
      output_name: "Verbadent.ipa"
    )
    
    upload_to_testflight(
      api_key: api_key,
      ipa: "#{PROJECT_ROOT}/build/ios/ipa/Verbadent.ipa",
      skip_waiting_for_build_processing: true
    )
    
    UI.success("âœ… iOS build uploaded to TestFlight!")
  end
  
  desc "Upload App Store metadata only (no binary)"
  lane :metadata do
    api_key = ios_api_key
    
    deliver(
      api_key: api_key,
      skip_binary_upload: true,
      skip_screenshots: false,
      skip_metadata: false,
      force: true,
      submit_for_review: false
    )
    
    UI.success("âœ… iOS metadata uploaded to App Store Connect!")
  end
  
  desc "Capture iOS screenshots"
  lane :screenshots do
    UI.message("ğŸ“± iOS Screenshot Capture")
    UI.message("=========================")
    
    # Note: Full automation requires UI test target in Xcode
    # snapshot
    
    UI.important("For manual screenshots:")
    UI.message("1. Run: flutter run -d 'iPhone 16 Pro Max'")
    UI.message("2. Navigate to each screen")
    UI.message("3. Press Cmd+S in Simulator to save screenshot")
    UI.message("4. Save to: fastlane/screenshots/en-US/")
    UI.message("")
    UI.message("Required devices:")
    UI.message("  - iPhone 16 Pro Max (6.9\")")
    UI.message("  - iPhone 15 Pro Max (6.7\")")
    UI.message("  - iPhone 8 Plus (5.5\")")
    UI.message("  - iPad Pro 12.9\"")
    UI.message("  - iPad Pro 11\"")
  end
  
  desc "Full release with metadata"
  lane :release do
    ENV["PATH"] = "/usr/bin:" + ENV["PATH"]
    
    api_key = ios_api_key
    
    get_certificates(api_key: api_key, platform: "ios")
    get_provisioning_profile(api_key: api_key, app_identifier: "com.verbident", platform: "ios")
    
    Dir.chdir(PROJECT_ROOT) do
      sh("flutter build ios --release --no-codesign")
    end
    
    build_app(
      workspace: "#{PROJECT_ROOT}/ios/Runner.xcworkspace",
      scheme: "Runner",
      export_method: "app-store",
      output_directory: "#{PROJECT_ROOT}/build/ios/ipa",
      output_name: "Verbadent.ipa"
    )
    
    deliver(
      api_key: api_key,
      ipa: "#{PROJECT_ROOT}/build/ios/ipa/Verbadent.ipa",
      skip_screenshots: false,
      skip_metadata: false,
      force: true,
      submit_for_review: false
    )
    
    UI.success("âœ… iOS release with metadata uploaded!")
  end
end

# =====================
# VERSION MANAGEMENT
# =====================

def get_current_version
  pubspec = File.read("#{PROJECT_ROOT}/pubspec.yaml")
  match = pubspec.match(/version:\s*(\d+)\.(\d+)\.(\d+)\+(\d+)/)
  {
    major: match[1].to_i,
    minor: match[2].to_i,
    patch: match[3].to_i,
    build: match[4].to_i,
    full: "#{match[1]}.#{match[2]}.#{match[3]}+#{match[4]}"
  }
end

def set_version(major, minor, patch, build)
  pubspec_path = "#{PROJECT_ROOT}/pubspec.yaml"
  pubspec = File.read(pubspec_path)
  new_version = "#{major}.#{minor}.#{patch}+#{build}"
  new_pubspec = pubspec.gsub(/version:\s*\d+\.\d+\.\d+\+\d+/, "version: #{new_version}")
  File.write(pubspec_path, new_pubspec)
  new_version
end

desc "Show current version"
lane :version do
  v = get_current_version
  UI.message("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
  UI.message("  Current Version: #{v[:major]}.#{v[:minor]}.#{v[:patch]}+#{v[:build]}")
  UI.message("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
  UI.message("  Major: #{v[:major]}  (breaking changes)")
  UI.message("  Minor: #{v[:minor]}  (new features)")
  UI.message("  Patch: #{v[:patch]}  (bug fixes)")
  UI.message("  Build: #{v[:build]}  (upload number)")
  UI.message("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")
end

desc "Bump build number only (same version, new upload)"
lane :bump do
  v = get_current_version
  new_version = set_version(v[:major], v[:minor], v[:patch], v[:build] + 1)
  UI.success("âœ… Build bumped: #{v[:full]} â†’ #{new_version}")
end

desc "Bump PATCH version (bug fixes) - resets build to 1"
lane :bump_patch do
  v = get_current_version
  new_version = set_version(v[:major], v[:minor], v[:patch] + 1, 1)
  UI.success("âœ… Patch bumped: #{v[:full]} â†’ #{new_version}")
  UI.important("Use this for: bug fixes, small improvements, text changes")
end

desc "Bump MINOR version (new features) - resets patch and build"
lane :bump_minor do
  v = get_current_version
  new_version = set_version(v[:major], v[:minor] + 1, 0, 1)
  UI.success("âœ… Minor bumped: #{v[:full]} â†’ #{new_version}")
  UI.important("Use this for: new features, significant improvements")
end

desc "Bump MAJOR version (breaking changes) - resets all"
lane :bump_major do
  v = get_current_version
  new_version = set_version(v[:major] + 1, 0, 0, 1)
  UI.success("âœ… Major bumped: #{v[:full]} â†’ #{new_version}")
  UI.important("Use this for: breaking changes, major redesign, v1.0.0 release")
end
